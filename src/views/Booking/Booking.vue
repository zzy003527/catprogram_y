<template>
    <div h="auto" w="auto" m="20" class="table" :style="{
        boxShadow: `var(${getCssVarName('light')})`
    }">
        <el-table ref="tableRef" row-key="date" :data="toRaw(tableData)" style="width: 100%;" size="large">
            <el-table-column prop="date" label="日期" width="180" column-key="date" :filters="
                // [ { text: '2016-05-01', value: '2016-05-01' }]
                filteArray
            " :filter-method="filterHandler">
            </el-table-column>
            <el-table-column prop="time" label="时间" width="150" />
            <el-table-column prop="availableNumber" label="可预约" width="330" style="text-align: center;" />
            <el-table-column prop="tag" label="预约" width="100" :filters="[
                { text: '可预约', value: '预约' },
                { text: '已预约', value: '取消预约' },
            ]" :filter-method="filterTag" filter-placement="bottom-end">
                <template #default="scope">
                    <!-- <el-tag :type="scope.row.tag === 'true' ? '' : 'success'" disable-transitions>{{ scope.row.tag }}
                </el-tag> -->
                    <booking-button ref="sonBtn" :scope="scope" :refresh='dataFill' />
                </template>
            </el-table-column>
        </el-table>
        <!-- <el-button @click="resetDateFilter" style="float:left ;margin-top: 10px;;">清除筛选</el-button> -->
    </div>


</template>

<script lang="ts" setup>
import { ElTable } from 'element-plus'
import type { TableColumnCtx } from 'element-plus/es/components/table/src/table-column/defaults'
// import { BookData } from '../../request/requestApi';
import axios from 'axios'
import { toRaw } from '@vue/reactivity';
import { ref } from 'vue';
import BookingButton from './BookingButton.vue'

// 样式
const getCssVarName = (type: string) => {
    return `--el-box-shadow${type ? '-' : ''}${type}`
}

// element内置代码
interface User {
    id: number
    number: number
    date: string
    time: string
    version: number
    availableNumber: number
    tag: string
}
//筛选函数
const filterTag = (value: string, row: User) => {
    return row.tag === value
}
//获取子组件
const sonBtn = ref()
//请求代码
// 输入表格数据格式
let tableData = ref([] as User[])
let filteArray = ref([] as Array<object>)
const dataFill = () =>
    axios({
        url: 'http://127.0.0.1:4523/m1/1473415-0-default/cat/reservation/number',
        method: 'post',
        params: {
            version: '0'
        }
    }).then(res => {
        let dataArray: Array<User> = []
        let data = res.data.obj
        // 填充表格
        filteArray.value = []
        let filteArrayData: Array<string> = []
        for (let i: number in data) {
            // 表格数据
            let obj = data[i].timetable
            if (obj.availableNumber > 0) obj.tag = '预约'
            else if (obj.availableNumber == 0) {
                obj.tag = '已满', console.log(sonBtn.value);
            }
            obj.date = data[i].timetable.timeQuantum.split(' ')[0]
            obj.time = data[i].timetable.timeQuantum.split(' ')[1].substring(0, 5)
            dataArray.push(data[i].timetable)
            // 筛选数据
            let filterObj = { text: '', value: '' }
            filterObj.text = obj.date
            filterObj.value = obj.date
            //判断该时间是否已存在于筛选数组
            if (!filteArrayData.includes(obj.date)) {
                filteArray.value.push(filterObj)
                filteArrayData.push(obj.date)
            }
        }
        tableData.value = dataArray
    })
dataFill()
//备用：一键解除筛选功能
// const tableRef = ref<InstanceType<typeof ElTable>>()
// const resetDateFilter = () => {
//     tableRef.value!.clearFilter(['date'])
// }
// TODO: improvement typing when refactor table

//筛选函数
const filterHandler = (
    value: string,
    row: User,
    column: TableColumnCtx<User>
) => {
    const property = column['property']
    return row[property] === value
}
</script>

<style scoped>
.table {
    padding: 50px;
    border-radius: 15px;
    box-shadow: 33px;
}
</style>